/** 
 *  Copyright (c) 1999~2017, Altibase Corp. and/or its affiliates. All rights reserved.
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Affero General Public License, version 3,
 *  as published by the Free Software Foundation.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 *  GNU Affero General Public License for more details.
 *
 *  You should have received a copy of the GNU Affero General Public License
 *  along with this program. If not, see <http://www.gnu.org/licenses/>.
 */

/***********************************************************************
 * $Id
 **********************************************************************/

#ifndef _O_SDT_SORT_SEGMENT_H_
#define _O_SDT_SORT_SEGMENT_H_ 1

#include <idl.h>
#include <smDef.h>
#include <smiDef.h>
#include <sdtDef.h>
#include <smuMemStack.h>
#include <smErrorCode.h>
#include <sdtTempPage.h>
#include <sdtWAExtentMgr.h>
#include <sctTableSpaceMgr.h>

class sdtSortSegment
{
public:

    static IDE_RC initializeStatic();
    static void   destroyStatic();
    static IDE_RC resetWASegmentSize( ULong aNewWorkAreaSize );
    static IDE_RC resizeWASegmentPool( UInt aNewWASegmentCount );

    static void lock()
    {
        (void)mMutex.lock( NULL );
    }
    static void unlock()
    {
        (void)mMutex.unlock();
    }

    static UInt getWAExtentCount()
    {
        return calcWAExtentCount( smuProperty::getSortAreaSize() ) ;
    }
    static UInt calcWAExtentCount( ULong aSortAreaSize )
    {
        return (UInt)(( aSortAreaSize + SDT_WAEXTENT_SIZE - 1 ) / SDT_WAEXTENT_SIZE);
    }
    static ULong getWAPageCount()
    {
        return calcWAPageCount( smuProperty::getSortAreaSize() ) ;
    }

    static ULong calcWAPageCount( ULong aSortAreaSize )
    {
        return (ULong)calcWAExtentCount( aSortAreaSize) * SDT_WAEXTENT_PAGECOUNT ;
    }
    static ULong getWASegmentSize()
    {
        return calcWASegmentSize( getWAPageCount() );
    }
    static ULong calcWASegmentSize( ULong aWAPageCount )
    {
        return SDT_SORT_SEGMENT_HEADER_SIZE + ( aWAPageCount * ID_SIZEOF(sdtWCB) );
    }

    static ULong getNPageHashMapPoolSize()
    {
        return (ULong)mNHashMapPool.getNodeSize() * mNHashMapPool.getNodeCount();
    };

    static ULong getSegPoolSize()
    {
        return (ULong)mWASegmentPool.getNodeSize() * mWASegmentPool.getNodeCount();
    };

    /******************************************************************
     * Segment
     ******************************************************************/
    static IDE_RC createSortSegment( smiTempTableHeader * aHeader,
                                     ULong                aInitWorkAreaSize );

    static UInt getMaxWAPageCount(sdtSortSegHdr* aWASegment )
    {
        return aWASegment->mMaxWAExtentCount * SDT_WAEXTENT_PAGECOUNT;
    };

    static UInt getWASegmentUsedPageCount(sdtSortSegHdr* aWASegment )
    {
        return (( aWASegment->mAllocWAPageCount + SDT_WAEXTENT_PAGECOUNT - 1 )
                / SDT_WAEXTENT_PAGECOUNT ) * SDT_WAEXTENT_PAGECOUNT;
    };

    static IDE_RC dropSortSegment(sdtSortSegHdr* aWASegment );
    static IDE_RC clearSortSegment(sdtSortSegHdr* aWASegment );
    static IDE_RC truncateSortSegment( sdtSortSegHdr* aWASegment );

    static IDE_RC expandFreeWAExtent( sdtSortSegHdr* aWASeg );
    static void   clearAllWCB( sdtSortSegHdr* aWASegment );

    /******************************************************************
     * Group
     ******************************************************************/
    static IDE_RC createWAGroup( sdtSortSegHdr    * aWASegment,
                                 sdtGroupID         aWAGroupID,
                                 UInt               aPageCount,
                                 sdtWAReusePolicy   aPolicy );
    static IDE_RC resetWAGroup( sdtSortSegHdr     * aWASegment,
                                sdtGroupID          aWAGroupID,
                                idBool              aWait4Flush );
    static IDE_RC clearWAGroup( sdtSortGroup      * aGrpInfo );

    inline static void initWCB( sdtWCB       * aWCBPtr );

    /************ Hint 贸府 ***************/
    inline static sdtWCB * getHintWCB( sdtSortGroup * aGrpInfo );
    inline static void setHintWCB( sdtSortGroup * aGroupInfo,
                                   sdtWCB       * aHintWCBPtr );
    inline static sdtSortGroup *getWAGroupInfo( sdtSortSegHdr* aWASegment,
                                                sdtGroupID     aWAGroupID );

    inline static UInt   getWAGroupPageCount( sdtSortGroup * aGrpInfo )
    {
        return aGrpInfo->mEndWPID - aGrpInfo->mBeginWPID;
    };

    inline static UInt   getAllocableWAGroupPageCount( sdtSortSegHdr* aWASegment,
                                                       sdtGroupID     aWAGroupID );
    static UInt   getAllocableWAGroupPageCount( sdtSortGroup   * aGrpInfo );

    inline static scPageID getFirstWPageInWAGroup( sdtSortSegHdr* aWASegment,
                                                   sdtGroupID     aWAGroupID )
    {
        return aWASegment->mGroup[ aWAGroupID ].mBeginWPID;
    };

    static scPageID getLastWPageInWAGroup( sdtSortSegHdr* aWASegment,
                                           sdtGroupID     aWAGroupID )
    {
        return aWASegment->mGroup[ aWAGroupID ].mEndWPID;
    };

    static IDE_RC getFreeWAPageFIFO( sdtSortSegHdr* aWASegment,
                                     sdtSortGroup * aGrpInfo,
                                     sdtWCB      ** aWCBPtr );
    static IDE_RC getFreeWAPageINMEMORY( sdtSortSegHdr* aWASegment,
                                         sdtSortGroup * aGrpInfo,
                                         sdtWCB      ** aWCBPtr );
    static IDE_RC getFreeWAPageLRU( sdtSortSegHdr* aWASegment,
                                    sdtSortGroup * aGrpInfo,
                                    sdtWCB      ** aWCBPtr );
    static IDE_RC getFreeWAPageLRUfromDisk( sdtSortSegHdr* aWASegment,
                                            sdtSortGroup * aGrpInfo,
                                            sdtWCB      ** aWCBPtr );
    static IDE_RC mergeWAGroup(sdtSortSegHdr    * aWASegment,
                               sdtGroupID         aWAGroupID1,
                               sdtGroupID         aWAGroupID2,
                               sdtWAReusePolicy   aPolicy );
    static IDE_RC splitWAGroup(sdtSortSegHdr    * aWASegment,
                               sdtGroupID         aSrcWAGroupID,
                               sdtGroupID         aDstWAGroupID,
                               sdtWAReusePolicy   aPolicy );

    static IDE_RC dropAllWAGroup( sdtSortSegHdr* aWASegment );
    static IDE_RC dropWAGroup(sdtSortSegHdr* aWASegment,
                              sdtGroupID     aWAGroupID,
                              idBool         aWait4Flush);

    /******************************************************************
     * Page 林家 包访 Operation
     ******************************************************************/
    inline static void convertFromWGRIDToNGRID( sdtSortSegHdr* aWASegment,
                                                scGRID         aWGRID,
                                                scGRID       * aNGRID );
    inline static IDE_RC getWCBByNPID( sdtSortSegHdr* aWASegment,
                                       sdtGroupID     aWAGroupID,
                                       scPageID       aNPID,
                                       sdtWCB      ** aRetWCB );
    inline static IDE_RC getWCBByGRID( sdtSortSegHdr* aWASegment,
                                       sdtGroupID     aWAGroupID,
                                       scGRID         aGRID,
                                       sdtWCB      ** aWCBPtr );

    /******************************************************************
     * Page 惑怕 包访 Operation
     ******************************************************************/
    /*************************  DirtyPage  ****************************/
    static IDE_RC makeInitPage( sdtSortSegHdr* aWASegment,
                                sdtWCB       * aWCBPtr,
                                idBool         aWait4Flush);
    inline static void bookedFree(sdtSortSegHdr* aWASegment,
                                  scPageID       aWPID);

    /*************************  Fix Page  ****************************/
    inline static void fixWAPage(sdtSortSegHdr* aWASegment,
                                 scPageID       aWPID);
    inline static void unfixWAPage(sdtSortSegHdr* aWASeg,
                                   scPageID       aWPID);
    inline static void fixWAPage(sdtWCB       * aWCBPtr );
    inline static void unfixWAPage(sdtWCB     * aWCBPtr );

    inline static idBool isFixedPage(sdtWCB         * aWCBPtr );
    /******************************************************************
     * Page沥焊包访 Operation
     ******************************************************************/
    inline static IDE_RC getPagePtrByGRID( sdtSortSegHdr * aWASegment,
                                           sdtGroupID      aGroupID,
                                           scGRID          aGRID,
                                           UChar        ** aNSlotPtr );

    inline static IDE_RC getPageWithFix( sdtSortSegHdr * aWASegment,
                                         sdtGroupID      aGroupID,
                                         scGRID          aGRID,
                                         UInt          * aWPID,
                                         UChar        ** aWAPagePtr,
                                         UInt          * aSlotCount );
    inline static IDE_RC getPage( sdtSortSegHdr * aWASegment,
                                  sdtGroupID      aGroupID,
                                  scGRID          aGRID,
                                  UInt          * aWPID,
                                  UChar        ** aWAPagePtr );
    inline static void getSlot( UChar         * aWAPagePtr,
                                UInt            aSlotCount,
                                UInt            aSlotNo,
                                UChar        ** aNSlotPtr,
                                idBool        * aIsValid );

    inline static sdtWCB * getWCBInternal(sdtSortSegHdr * aWASegment,
                                          scPageID        aWPID );
    inline static sdtWCB * getWCBWithLnk(sdtSortSegHdr * aWASegment,
                                         scPageID        aWPID );
    inline static UChar*  getWAPagePtr( sdtSortSegHdr * aWASegment,
                                        sdtGroupID      aGroupID,
                                        sdtWCB        * aWCBPtr );
    inline static UChar*  getWAPagePtr( sdtWCB        * aWCBPtr );

    inline static  IDE_RC chkAndSetWAPagePtr( sdtSortSegHdr * aWASegment,
                                              sdtWCB        * aWCBPtr );
    static  IDE_RC setWAPagePtr( sdtSortSegHdr * aWASegment,
                                 sdtWCB        * aWCBPtr );

    inline static scPageID  getNPID( sdtSortSegHdr* aWASegment,
                                     scPageID       aWPID )
    {
        return getNPID( getWCBInternal( aWASegment, aWPID ) );
    };

    inline static scPageID  getNPID( sdtWCB * aWCBPtr )
    {
        return aWCBPtr->mNPageID;
    }

    static scPageID  getWPageID( sdtSortSegHdr* aWASegment,
                                 sdtWCB       * aWCBPtr )
    {
        return (scPageID)( aWCBPtr - aWASegment->mWCBMap );
    }

    /*************************************************
     * NormalPage Operation
     *************************************************/
    static IDE_RC assignNPage(sdtSortSegHdr* aWASegment,
                              sdtWCB       * aWCBPtr,
                              scPageID       aNPageID);
    static IDE_RC unassignNPage(sdtSortSegHdr* aWASegment,
                                sdtWCB       * aWCBPtr );
    static IDE_RC moveWAPage( sdtSortSegHdr* aWASegment,
                              sdtWCB       * aSrcWCBPtr,
                              sdtWCB       * aDstWCBPtr );

    inline static UInt getNPageHashValue( sdtSortSegHdr* aWASegment,
                                          scPageID       aNPID);
    inline static sdtWCB * findWCB( sdtSortSegHdr* aWASegment,
                                    scPageID       aNPID);
    static IDE_RC readNPageFromDisk(sdtSortSegHdr* aWASegment,
                                    sdtGroupID     aWAGroupID,
                                    sdtWCB       * aWCBPtr,
                                    scPageID       aNPageID);
    static IDE_RC readNPage(sdtSortSegHdr* aWASegment,
                            sdtGroupID     aWAGroupID,
                            sdtWCB       * aWCBPtr,
                            scPageID       aNPageID);
    static IDE_RC writeNPage( sdtSortSegHdr* aWASegment,
                              sdtWCB       * aWCBPtr );
    static IDE_RC pushFreePage(sdtSortSegHdr* aWASegment,
                               scPageID       aNPID);
    static IDE_RC allocAndAssignNPage(sdtSortSegHdr* aWASegment,
                                      sdtWCB       * aTargetWCBPtr );

    static UInt   getNExtentCount( sdtSortSegHdr* aWASegment )
    {
        return aWASegment->mNExtFstPIDList.mCount;
    }

    static idBool   isWorkAreaTbsID( scSpaceID aSpaceID )
    {
        return ( aSpaceID == SDT_SPACEID_WORKAREA ) ? ID_TRUE : ID_FALSE ;
    }
public:

    static void moveLRUListToTopInternal( sdtSortSegHdr* aWASegment,
                                          sdtSortGroup * aGrpInfo,
                                          sdtWCB       * aWCBPtr );

private:
    inline static void moveLRUListToTop( sdtSortSegHdr* aWASegment,
                                         sdtGroupID     aWAGroupID,
                                         sdtWCB       * aWCBPtr );

#ifdef DEBUG
    static IDE_RC validateLRUList( sdtSortSegHdr* aWASegment,
                                   sdtSortGroup * aGrpInfo );
#endif
public:
    static sdtGroupID   findGroup( sdtSortSegHdr* aWASegment,
                                   scPageID       aWPageID );

    /***********************************************************
     * Dump侩 窃荐甸
     ***********************************************************/
    static sdtWAReusePolicy getReusePolicy( sdtSortSegHdr* aWASegment,
                                            scPageID       aWAPageID );
    static void exportSortSegmentToFile( sdtSortSegHdr* aWASegment );
    static IDE_RC importSortSegmentFromFile( SChar         * aFileName,
                                             sdtSortSegHdr** aSortSegHdr,
                                             sdtSortSegHdr * aRawSortSegHdr,
                                             UChar        ** aPtr );
    static IDE_RC resetWCBInfo4Dump( sdtSortSegHdr * aWASegment,
                                     UChar         * aOldWASegPtr,
                                     UInt            aMaxPageCount,
                                     UChar        ** aPtr );
    static void dumpWASegment( void           * aWASegment,
                               SChar          * aOutBuf,
                               UInt             aOutSize );
    static void dumpWAGroup( sdtSortSegHdr  * aWASegment,
                             sdtGroupID       aWAGroupID ,
                             SChar          * aOutBuf,
                             UInt             aOutSize );
    
    static void dumpWCBs( void           * aWASegment,
                          SChar          * aOutBuf,
                          UInt             aOutSize );
    static void dumpWCB( void           * aWCB,
                         SChar          * aOutBuf,
                         UInt             aOutSize );
private:
    static iduMutex      mMutex;
    static smuMemStack   mWASegmentPool;
    static smuMemStack   mNHashMapPool;
} ;


/**************************************************************************
 * Description :
 *      HintPage啊廉咳
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWAGroupID     - 措惑 Group ID
 ***************************************************************************/
sdtWCB * sdtSortSegment::getHintWCB( sdtSortGroup * aGrpInfo )
{
    return aGrpInfo->mHintWCBPtr;
}

/**************************************************************************
 * Description :
 *      HintPage甫 汲沥窃.
 *      HintPage绰 unfix登搁 救登扁俊 绊沥矫难狄
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWAGroupID     - 措惑 Group ID
 ***************************************************************************/
void sdtSortSegment::setHintWCB( sdtSortGroup * aGroupInfo,
                                 sdtWCB       * aHintWCBPtr )
{
    if ( aGroupInfo->mHintWCBPtr != aHintWCBPtr )
    {
        if ( aGroupInfo->mHintWCBPtr != NULL )
        {
            unfixWAPage( aGroupInfo->mHintWCBPtr );
        }

        aGroupInfo->mHintWCBPtr = aHintWCBPtr;

        if ( aHintWCBPtr != NULL )
        {
            fixWAPage( aHintWCBPtr );
        }
    }
}

/**************************************************************************
 * Description :
 * GroupInfo狼 器牢磐 啊廉柯促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWAGroupID     - 措惑 Group ID
 ***************************************************************************/
sdtSortGroup *sdtSortSegment::getWAGroupInfo( sdtSortSegHdr* aWASegment,
                                              sdtGroupID     aWAGroupID )
{
    return &aWASegment->mGroup[ aWAGroupID ];
}

/**************************************************************************
 * Description :
 *      唱吝俊 unassign瞪锭 Free登档废, 钎矫秦敌促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWPID          - WAPageID
 ***************************************************************************/
void sdtSortSegment::bookedFree( sdtSortSegHdr* aWASegment,
                                 scPageID       aWPID )
{
    sdtWCB   * sWCBPtr;

    sWCBPtr = getWCBInternal( aWASegment, aWPID );

    if ( sWCBPtr->mNPageID == SC_NULL_PID )
    {
        /* 且寸 登绢乐瘤 臼栏搁, 公矫秦档 等促. */
    }
    else
    {
        sWCBPtr->mBookedFree = ID_TRUE;
    }
}

/**************************************************************************
 * Description :
 *      秦寸 WAPage啊 discard登瘤 臼档废 绊沥茄促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWPID          - WAPageID
 ***************************************************************************/
void sdtSortSegment::fixWAPage( sdtSortSegHdr* aWASegment,
                                scPageID       aWPID)
{
    sdtWCB   * sWCBPtr;

    sWCBPtr = getWCBInternal( aWASegment, aWPID );

    aWASegment->mHintWCBPtr = sWCBPtr;

    fixWAPage( sWCBPtr );
}

void sdtSortSegment::fixWAPage( sdtWCB       * aWCBPtr )
{
    aWCBPtr->mFix++;

    IDE_DASSERT( aWCBPtr->mNxtUsedWCBPtr != NULL );

    IDE_ASSERT( aWCBPtr->mFix > 0 );
}

/**************************************************************************
 * Description :
 *      FixPage甫 钱绢 Discard甫 倾侩茄促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWPID          - WAPageID
 ***************************************************************************/
void sdtSortSegment::unfixWAPage( sdtSortSegHdr* aWASeg,
                                  scPageID       aWPID)
{
    sdtWCB   * sWCBPtr;

    sWCBPtr = getWCBInternal( aWASeg, aWPID );

    unfixWAPage( sWCBPtr );
}

void sdtSortSegment::unfixWAPage( sdtWCB       * aWCBPtr )
{
    IDE_ASSERT( aWCBPtr->mFix > 0 );

    aWCBPtr->mFix--;
}

/**************************************************************************
 * Description :
 *     Page 林家肺 HashValue积己
 *
 * <IN>
 * aNSpaceID,aNPID- Page林家
 ***************************************************************************/
UInt sdtSortSegment::getNPageHashValue( sdtSortSegHdr* aWASegment,
                                        scPageID       aNPID )
{
    return  ( aNPID ) % aWASegment->mNPageHashBucketCnt;
}

/**************************************************************************
 * Description :
 *     NPageHash甫 第廉辑 秦寸 NPage甫 啊柳 WPage甫 茫酒晨
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aNPID          - Page林家
 ***************************************************************************/
sdtWCB * sdtSortSegment::findWCB( sdtSortSegHdr* aWASegment,
                                  scPageID       aNPID )
{
    UInt       sHashValue = getNPageHashValue( aWASegment, aNPID );
    sdtWCB   * sWCBPtr;

    sWCBPtr = aWASegment->mNPageHashPtr[ sHashValue ];

    while( sWCBPtr != NULL )
    {
        /* HashValue啊 嘎酒具 窃 */
        IDE_DASSERT( getNPageHashValue( aWASegment, sWCBPtr->mNPageID )
                     == sHashValue );

        if ( sWCBPtr->mNPageID == aNPID )
        {
            break;
        }
        else
        {
            /* nothing to do */
        }

        sWCBPtr  = sWCBPtr->mNextWCB4Hash;
    }

    return sWCBPtr;
}

/**************************************************************************
 * Description :
 *     WA俊辑狼 GRID甫 NGRID肺 函版窃
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWGRID         - 函版且 盔夯 WGRID
 * <OUT>
 * aNGRID         - 掘篮 蔼
 ***************************************************************************/
void sdtSortSegment::convertFromWGRIDToNGRID( sdtSortSegHdr* aWASegment,
                                              scGRID         aWGRID,
                                              scGRID       * aNGRID )
{
    sdtWCB         * sWCBPtr;

    if ( SC_MAKE_SPACE( aWGRID ) == SDT_SPACEID_WORKAREA )
    {
        /* WGRID咯具 窍绊, InMemoryGroup酒聪绢具 窃 */
        sWCBPtr = getWCBInternal( aWASegment,
                                  SC_MAKE_PID( aWGRID ) );

        /* NPID客 Assign 登绢具父 狼固 乐澜 */
        if ( sWCBPtr->mWPState != SDT_WA_PAGESTATE_INIT )
        {
            SC_MAKE_GRID( *aNGRID,
                          aWASegment->mSpaceID,
                          sWCBPtr->mNPageID,
                          SC_MAKE_OFFSET( aWGRID ) );
        }
        else
        {
            /* nothing to do */
        }
    }
    else
    {
        /* nothing to do */
    }
}

/**************************************************************************
 * Description :
 *     WASegment郴俊辑 秦寸 NPage甫 茫绰促.
 *     其捞瘤啊 绝栏搁, Group俊辑 VictimPage甫 茫酒辑 佬绢辑 倒妨霖促.
 *     弊犯霸 茫酒辑 WCB甫 馆券茄促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWAGroupID     - 措惑 Group ID
 * aNSpaceID,aNPID- Page林家
 * <OUT>
 * aRetWCB        - 掘篮 蔼
 ***************************************************************************/
IDE_RC sdtSortSegment::getWCBByNPID(sdtSortSegHdr* aWASegment,
                                    sdtGroupID     aWAGroupID,
                                    scPageID       aNPID,
                                    sdtWCB      ** aRetWCB )
{
    sdtWCB      * sWCBPtr = NULL;
    sdtSortGroup* sGrpInfo;

    if ( ( aWASegment->mHintWCBPtr->mNPageID == aNPID ) )
    {
        (*aRetWCB) = aWASegment->mHintWCBPtr;
        IDE_ASSERT( aWASegment->mHintWCBPtr->mWAPagePtr != NULL );
    }
    else
    {
        (*aRetWCB) = findWCB( aWASegment, aNPID );

        if ( (*aRetWCB) == NULL )
        {
            /* WA惑俊 其捞瘤啊 粮犁窍瘤 臼阑 版快, 后 其捞瘤甫 Group俊 且寸罐酒
             * Read窃*/
            IDE_ASSERT ( aWAGroupID != SDT_WAGROUPID_NONE );

            sGrpInfo  = getWAGroupInfo( aWASegment, aWAGroupID );

            switch( sGrpInfo->mPolicy )
            {
                case SDT_WA_REUSE_FIFO:
                    IDE_TEST( getFreeWAPageFIFO( aWASegment,
                                                 sGrpInfo,
                                                 &sWCBPtr )
                              != IDE_SUCCESS );
                    break;
                case SDT_WA_REUSE_LRU:
                    IDE_TEST( getFreeWAPageLRU( aWASegment,
                                                sGrpInfo,
                                                &sWCBPtr )
                              != IDE_SUCCESS );
                    break;
                default:
                    IDE_ASSERT(0);
                    break;
            }

            IDE_TEST( readNPage( aWASegment,
                                 aWAGroupID,
                                 sWCBPtr,
                                 aNPID )
                      != IDE_SUCCESS );
            (*aRetWCB) = sWCBPtr;
        }
        else
        {
            /* nothing to do */
            IDE_ASSERT( (*aRetWCB)->mWAPagePtr != NULL );
        }
    }

    return IDE_SUCCESS;

    IDE_EXCEPTION_END;

    ideLog::log( IDE_DUMP_0,
                 "aWAGroupID : %u\n"
                 "aNSpaceID  : %u\n"
                 "aNPID      : %u\n"
                 "sWPID      : %u\n",
                 aWAGroupID,
                 aWASegment->mSpaceID,
                 aNPID,
                 (sWCBPtr != NULL) ? getWPageID( aWASegment, sWCBPtr ) : SD_NULL_PID );

    IDE_DASSERT( 0 );

    return IDE_FAILURE;
}

/**************************************************************************
 * Description :
 * GRID甫 官帕栏肺 WPID甫 啊廉柯促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWAGroupID     - 措惑 Group ID
 * aGRID          - 啊廉棵 盔夯 GRID
 * <OUT>
 * aRetPID        - 搬苞 WPID
 ***************************************************************************/
IDE_RC sdtSortSegment::getWCBByGRID( sdtSortSegHdr* aWASegment,
                                     sdtGroupID     aWAGroupID,
                                     scGRID         aGRID,
                                     sdtWCB       **aWCBPtr )
{
    if ( SC_MAKE_SPACE( aGRID ) == SDT_SPACEID_WORKAREA )
    {
        (*aWCBPtr) = NULL;
    }
    else
    {
        IDE_TEST( sdtSortSegment::getWCBByNPID( aWASegment,
                                                aWAGroupID,
                                                SC_MAKE_PID( aGRID ),
                                                aWCBPtr )
                  != IDE_SUCCESS );
    }

    return IDE_SUCCESS;

    IDE_EXCEPTION_END;

    return IDE_FAILURE;
}


/**************************************************************************
 * Description :
 *     WGRID甫 官帕栏肺 秦寸 Slot狼 器牢磐甫 馆券茄促.
 *
 * <IN>
 * aWAPagePtr     - 措惑 WAPage狼 器牢磐
 * aGroupID       - 措惑 GroupID
 * aGRID          - 措惑 GRID 蔼
 * <OUT>
 * aNSlotPtr      - 掘篮 浇吩
 * aIsValid       - Slot锅龋啊 棵官弗啊? ( Page啊 厚菌带啊, overflow扼带啊 )
 ***************************************************************************/
IDE_RC sdtSortSegment::getPagePtrByGRID( sdtSortSegHdr * aWASegment,
                                         sdtGroupID      aGroupID,
                                         scGRID          aGRID,
                                         UChar        ** aNSlotPtr )

{
    UChar         * sWAPagePtr = NULL;
    scPageID        sWPID;
    idBool          sIsValid;

    IDE_TEST( getPage( aWASegment,
                       aGroupID,
                       aGRID,
                       &sWPID,
                       &sWAPagePtr )
              != IDE_SUCCESS );

    getSlot( sWAPagePtr,
             sdtTempPage::getSlotCount( sWAPagePtr ),
             SC_MAKE_OFFSET( aGRID ),
             aNSlotPtr,
             &sIsValid );

    IDE_ERROR( sIsValid == ID_TRUE );

    return IDE_SUCCESS;

    IDE_EXCEPTION_END;

    return IDE_FAILURE;
}

/**************************************************************************
 * Description :
 *     getPage客 悼老窍登, 秦寸 Page甫 Fix矫虐扁档 茄促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aGroupID       - 措惑 GroupID
 * aGRID          - 措惑 GRID 蔼
 * <OUT>
 * aWPID          - 掘篮 WPID
 * aWAPagePtr     - 掘篮 WAPage狼 困摹
 * aSlotCount     - 秦寸 page狼 SlotCount
 ***************************************************************************/
IDE_RC sdtSortSegment::getPageWithFix( sdtSortSegHdr * aWASegment,
                                       sdtGroupID      aGroupID,
                                       scGRID          aGRID,
                                       UInt          * aWPID,
                                       UChar        ** aWAPagePtr,
                                       UInt          * aSlotCount )
{
    if ( *aWPID != SC_NULL_PID )
    {
        IDE_DASSERT( *aWAPagePtr != NULL );
        unfixWAPage( aWASegment, *aWPID );
    }
    else
    {
        /* nothing to do */
    }

    IDE_TEST( getPage( aWASegment,
                       aGroupID,
                       aGRID,
                       aWPID,
                       aWAPagePtr )
              != IDE_SUCCESS );

    *aSlotCount = sdtTempPage::getSlotCount( *aWAPagePtr );

    fixWAPage( aWASegment, *aWPID );

    return IDE_SUCCESS;

    IDE_EXCEPTION_END;

    return IDE_FAILURE;
}

/**************************************************************************
 * Description :
 *     GRID甫 官帕栏肺 Page俊 措茄 沥焊甫 掘绰促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aGroupID       - 措惑 GroupID
 * aGRID          - 措惑 GRID 蔼
 * <OUT>
 * aWPID          - 掘篮 WPID
 * aWAPagePtr     - 掘篮 WAPage狼 困摹
 * aSlotCount     - 秦寸 page狼 SlotCount
 ***************************************************************************/
IDE_RC sdtSortSegment::getPage( sdtSortSegHdr * aWASegment,
                                sdtGroupID      aGroupID,
                                scGRID          aGRID,
                                UInt          * aWPID,
                                UChar        ** aWAPagePtr )
{
    sdtWCB    * sWCBPtr;
    scSpaceID   sSpaceID;
    scPageID    sPageID;

    IDE_DASSERT( SC_GRID_IS_NOT_NULL( aGRID ));

    sSpaceID = SC_MAKE_SPACE( aGRID );
    sPageID  =  SC_MAKE_PID( aGRID );

    if ( isWorkAreaTbsID( sSpaceID ) == ID_TRUE )
    {
        sWCBPtr  = getWCBInternal( aWASegment, sPageID );
        (*aWPID) = sPageID;
        (*aWAPagePtr) = getWAPagePtr( aWASegment,
                                      aGroupID,
                                      sWCBPtr );
    }
    else
    {
        IDE_TEST_RAISE( sctTableSpaceMgr::isTempTableSpace( sSpaceID ) != ID_TRUE,
                        tablespaceID_error );

        IDE_TEST( getWCBByNPID( aWASegment,
                                aGroupID,
                                sPageID,
                                &sWCBPtr ) != IDE_SUCCESS );
        (*aWPID)      =  getWPageID( aWASegment , sWCBPtr );

        (*aWAPagePtr) = sWCBPtr->mWAPagePtr;

        IDE_ASSERT( sWCBPtr->mWAPagePtr != NULL );
    }

    return IDE_SUCCESS;

    IDE_EXCEPTION( tablespaceID_error );
    {
        ideLog::log( IDE_SM_0,
                     "[FAILURE] Fatal error during fetch disk temp table"
                     "(Tablespace ID : %"ID_UINT32_FMT", Page ID : %"ID_UINT32_FMT")",
                     sSpaceID,
                     sPageID );
        IDE_SET( ideSetErrorCode( smERR_ABORT_INTERNAL ) );
    }
    IDE_EXCEPTION_END;

    return IDE_FAILURE;
}
/**************************************************************************
 * Description :
 *     getPage茄 沥焊甫 官帕栏肺  Slot档 掘绰促.
 *
 * <IN>
 * aWAPagePtr     - 措惑 WAPage狼 器牢磐
 * aSlotCount     - 措惑 Page狼 Slot 俺荐
 * aSlotNo        - 掘阑 浇吩 锅龋
 * <OUT>
 * aNSlotPtr      - 掘篮 浇吩
 * aIsValid       - Slot锅龋啊 棵官弗啊? ( Page啊 厚菌带啊, overflow扼带啊 )
 ***************************************************************************/
void sdtSortSegment::getSlot( UChar         * aWAPagePtr,
                              UInt            aSlotCount,
                              UInt            aSlotNo,
                              UChar        ** aNSlotPtr,
                              idBool        * aIsValid )
{
    if ( aSlotCount > aSlotNo )
    {
        *aNSlotPtr = aWAPagePtr +
            sdtTempPage::getSlotOffset( aWAPagePtr, (scSlotNum)aSlotNo );
        *aIsValid  = ID_TRUE;
    }
    else
    {
        /* Slot阑 逞绢埃 版快.*/
        *aNSlotPtr = aWAPagePtr;
        *aIsValid  = ID_FALSE;
    }
}

/**************************************************************************
 * Description :
 *     WPID甫 官帕栏肺 WAPage狼 器牢磐甫 馆券茄促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aGroupID       - 措惑 GroupID
 * aWPID          - 措惑 Page
 ***************************************************************************/
UChar* sdtSortSegment::getWAPagePtr(sdtSortSegHdr * aWASegment,
                                    sdtGroupID      aGroupID,
                                    sdtWCB        * aWCBPtr )
{
    IDE_ASSERT( aWCBPtr->mWAPagePtr != NULL );

    if ( aWASegment->mHintWCBPtr != aWCBPtr )
    {
        moveLRUListToTop( aWASegment,
                          aGroupID,
                          aWCBPtr );

        aWASegment->mHintWCBPtr = aWCBPtr;
    }
    else
    {
        /* nothing to do */
    }

    return aWCBPtr->mWAPagePtr;
}


UChar * sdtSortSegment::getWAPagePtr( sdtWCB        * aWCBPtr )
{
    IDE_DASSERT( aWCBPtr != NULL );
    IDE_DASSERT( aWCBPtr->mWAPagePtr != NULL );

    return aWCBPtr->mWAPagePtr;
}


IDE_RC sdtSortSegment::chkAndSetWAPagePtr( sdtSortSegHdr * aWASegment,
                                           sdtWCB        * aWCBPtr )
{
    IDE_ASSERT( aWCBPtr->mNxtUsedWCBPtr != NULL );

    if ( aWCBPtr->mWAPagePtr == NULL )
    {
        return setWAPagePtr(aWASegment, aWCBPtr);
    }
    return IDE_SUCCESS;
}


/**************************************************************************
 * Description :
 *     WPID甫 官帕栏肺 WCB狼 困摹甫 馆券茄促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWPID          - 措惑 Page ID
 ***************************************************************************/
sdtWCB * sdtSortSegment::getWCBInternal( sdtSortSegHdr * aWASegment,
                                         scPageID        aWPID )
{
    IDE_DASSERT( getMaxWAPageCount( aWASegment ) > aWPID );

    return &aWASegment->mWCBMap[aWPID];
}

/**************************************************************************
 * Description :
 *     WPID甫 官帕栏肺 WCB狼 困摹甫 馆券茄促.
 *     Used List俊 楷搬登绢 乐瘤 臼栏搁 楷搬茄促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWPID          - 措惑 Page ID
 ***************************************************************************/
sdtWCB * sdtSortSegment::getWCBWithLnk( sdtSortSegHdr * aWASegment,
                                        scPageID        aWPID )
{
    sdtWCB * sWCBPtr;

    IDE_DASSERT( getMaxWAPageCount( aWASegment ) > aWPID );

    sWCBPtr = &aWASegment->mWCBMap[aWPID];

    if ( sWCBPtr->mNxtUsedWCBPtr == NULL )
    {
        sWCBPtr->mNxtUsedWCBPtr = aWASegment->mUsedWCBPtr;
        aWASegment->mUsedWCBPtr = sWCBPtr;
    }

    return sWCBPtr;
}

/**************************************************************************
 * Description :
 * WCB甫 官帕栏肺 Page狼 Fix咯何甫 馆券茄促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWPID          - 措惑 WPID
 ***************************************************************************/
idBool sdtSortSegment::isFixedPage( sdtWCB       * aWCBPtr )
{
    return (aWCBPtr->mFix > 0) ? ID_TRUE : ID_FALSE;
}

/**************************************************************************
 * Description :
 * WCB甫 檬扁拳茄促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWCBPtr        - 措惑 WCBPtr
 * aWPID          - 秦寸 WCB啊 啊龙 WPAGEID
 ***************************************************************************/
void sdtSortSegment::initWCB( sdtWCB  * aWCBPtr )
{
    aWCBPtr->mWPState    = SDT_WA_PAGESTATE_INIT;
    aWCBPtr->mNPageID    = SC_NULL_PID;
    aWCBPtr->mFix        = 0;
    aWCBPtr->mBookedFree = ID_FALSE;
    aWCBPtr->mNextWCB4Hash = NULL;
}

/**************************************************************************
 * Description :
 * Map捞 瞒瘤窍绰 困摹甫 猾, 荤侩 啊瓷茄 Group狼 农扁甫 Page俺荐肺 罐绰促.
 *
 * <IN>
 * aWASegment     - 措惑 WASegment
 * aWAGroupID     - 措惑 Group ID
 ***************************************************************************/
UInt sdtSortSegment::getAllocableWAGroupPageCount( sdtSortSegHdr* aWASegment,
                                                   sdtGroupID     aWAGroupID )
{
    sdtSortGroup   * sGrpInfo = getWAGroupInfo( aWASegment, aWAGroupID );

    return getAllocableWAGroupPageCount( sGrpInfo );
}

void sdtSortSegment::moveLRUListToTop( sdtSortSegHdr* aWASegment,
                                       sdtGroupID     aWAGroupID,
                                       sdtWCB       * aWCBPtr )
{
    sdtSortGroup   * sGrpInfo;
    scPageID         sWPageID;

    if ( ( aWAGroupID != SDT_WAGROUPID_NONE ) &&
         ( aWAGroupID != SDT_WAGROUPID_INIT ) &&
         ( aWAGroupID != SDT_WAGROUPID_MAX )  &&
         ( aWCBPtr->mLRUPrevPID != SM_NULL_PID )) // NULL : 捞固 top捞芭唱 LRU啊 酒聪促.
    {
        sGrpInfo = &aWASegment->mGroup[ aWAGroupID ];

        sWPageID = getWPageID( aWASegment,
                               aWCBPtr );

        if ( ( sGrpInfo->mPolicy       == SDT_WA_REUSE_LRU ) &&
             ( sGrpInfo->mReuseWPIDTop != sWPageID ) )
        {
            IDE_DASSERT(( sGrpInfo->mBeginWPID <= sWPageID ) &&
                        ( sGrpInfo->mEndWPID   >  sWPageID ));

            moveLRUListToTopInternal( aWASegment,
                                      sGrpInfo,
                                      aWCBPtr );
        }
    }

    return ;
}


#endif //_O_SDT_SORT_SEGMENT_H_
